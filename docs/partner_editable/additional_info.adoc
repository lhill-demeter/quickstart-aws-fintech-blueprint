// Add steps as necessary for accessing the software, post-configuration, and testing. Don’t include full usage instructions for your software, but add links to your product documentation for that information.
//Should any sections not be applicable, remove them

//== Test the deployment
// If steps are required to test the deployment, add them here. If not, remove the heading

:xrefstyle: short

== Post-deployment steps

=== (Recommended) Delete the default VPC

Every new account created in AWS comes with a default VPC, such as the one highlighted in <<DeleteDefaultVPC>>. This VPC is listed in the VPC console along with the production, management, and development VPCs created by this Quick Start. 

[#DeleteDefaultVPC]
.Deleting the default VPC
[link=images/defaultvpc_0.png]
image::../images/defaultvpc_0.png[DeleteDefaultVPC]

The default VPC has public subnets in every Availability Zone. It is a fundamentally insecure VPC. Do not use it. 

TIP: If you have a new account and have never launched anything into the default VPC, delete the default VPC and use only the VPCs created by the Quick Start. If you've already launched resources into the default VPC, migrate them to the VPCs created by the Quick Start, and then delete the default VPC. By deleting the default VPC, you reduce the chances of a user launching a resource into an exposed public subnet. 

=== (Optional) Modify the default configurations

While you don't have to modify any code to get started, you may decide you would like to change some of the default configurations after deploying the Quick Start. For example, the default internal DNS apex is a generic TLD `.corp` instead of `yourcompany.com`. To change the DNS apex or any configuration you see in the code, you make the change, build the project, and run `CDK deploy`. The CDK automatically figures out the necessary AWS CloudFormation change set and applies only the changes you've made.

For example, you can open the `lib/aws-startup-blueprint-stack.ts` file and update the DNS construct to use `yourcompany.com` instead of `corp`. 
    
    new Dns(this,'Dns', {
      ... ,
      TopLevelDomain: "yourcompany.com"      
    });

To apply that change, build and deploy as you did before:

  npm run build && cdk deploy

The CDK automatically creates and applies an AWS CloudFormation change set that creates a new hosted zone, attaches it to all the VPCs, and deletes the old hosted zone in just a few minutes. Updates take less time than the initial deployment because you only update resources that you've changed in the code. 

//TODO Shivansh/Paul, Please clarify what "hosted zone" refers to. For example, does it correspond to anything we show in the architecture diagram?

=== Connect to the VPN

//TODO Shivansh/Paul: The step numbers below are rendering incorrectly. For details on how to fix them, see our wiki instructions: https://w.amazon.com/bin/view/AWS_Quick_Starts/docs2_0#HNumberedsteps. To confirm that you've fixed the numbering, generate the doc and preview it. (I've fixed a number of the procedures in this guide already. I left this one for you to make sure that you know how to do this for future guides.)

After the deployment is complete, you connect to the VPN to route into the private subnets in the VPCs. The {partner-product-name} Quick Start deploys a client VPN endpoint in the management VPC that sends NAT traffic over peering connections into the production and development VPCs. The management VPC acts as a hub VPC for networking into other VPCs. The development and production environments do not communicate with each other, as shown in <<vpn1>>.

[#vpn1]
.VPN routing rules in the {partner-product-short-name} on AWS
[link=VPNRoutingDiagram.png]
image::../images/VPNRoutingDiagram.png[VPN, 70%]

. Go to the https://console.aws.amazon.com/vpc/home?#ClientVPNEndpoints:sort=clientVpnEndpointId[Client VPN endpoint section in the AWS VPC web console]. 

. Select the Client VPN endpoint listed, and choose *Download Client Configuration*, as shown in <<VPNConfig>>. Your browser downloads *client-config.ovpn*.

[#VPNConfig]
.Downloading the client-configuration file
[link=downloadclientconfig.png]
image::../images/downloadclientconfig.png[VPNConfig]

. Go to the AWS S3 console, and open the bucket prefixed `awsstartupblueprintstack-clientvpnvpnconfigbucket`. Five files are listed. Download *client1.domain.tld.key* and *client1.domain.tld.crt*. The other three files are the certificate authority (CA) chain and server key/certificate. You need those later if you create additional client certificates.

. Open the downloaded file *client-config.ovpn* in a text editor.

. Add the following lines to the bottom of the file. Replace the *<cert>* and *<key>* sections with the contents of the two files.


```
<cert>
Contents of client certificate (client1.domain.tld.crt) file
</cert>

<key>
Contents of private key (client1.domain.tld.key) file
</key>
```

. Save *client-config.ovpn*. You should be able to open or import that file with any OpenVPN client. 

AWS offers is own lightweight VPN client that works on most operating systems. For installation and usage instructions, see https://docs.aws.amazon.com/vpn/latest/clientvpn-user/connect-aws-client-vpn-connect.html[Connect using an AWS provided client^].

For usage instructions for other https://openvpn.net/download-open-vpn/[OpenVPN clients^], see https://docs.aws.amazon.com/vpn/latest/clientvpn-user/connect.html[Connect using an OpenVPN client^].


//== Test the deployment
// If steps are required to test the deployment, add them here. If not, remove the heading


//== Best practices for using {partner-product-short-name} on AWS
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

//_Add any best practices for using the software._

== Security and compliance
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

For automatic alerting when resources may have been deployed insecurely, this Quick Start deploys the following AWS Config https://docs.aws.amazon.com/config/latest/developerguide/conformance-packs.html[conformance packs^]:

* https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-pci-dss.html[Operational Best Practices for PCI-DSS-3.2.1^]
* https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-aws-identity-and-access-management.html[Operational Best Practices For AWS Identity And Access Management^]
* https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-amazon-s3.html[Operational Best Practices For Amazon S3^]
* https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-nist-csf.html[Operational Best Practices for NIST CSF^]
* https://docs.aws.amazon.com/config/latest/developerguide/aws-control-tower-detective-guardrails.html[AWS Control Tower Detective Guardrails Conformance Pack^]

These conformance packs create AWS Config rules that regularly evaluate resources in your AWS account against security best practices. When AWS Config finds an offending resource, it flags that resource for your review in the AWS Config console. AWS Config also scans resources created in your account before deploying the Quick Start.

For example, the Operational Best Practices for NIST Cyber Security Framework (CSF) conformance pack comes with 93 rules. One of those rules—`encrypted-volumes-conformance-pack`, highlighted in <<conformance_pack0>>—checks whether attached Amazon Elastic Block Store (Amazon EBS) volumes are encrypted. 

[#conformance_pack0]
.List of rules in the Operational Best Practices for NIST-CSF conformance pack
[link=images/conformancepacks_0.png]
image::../images/conformancepacks_0.png[Conformance packs0]

Choosing the rule `encrypted-volumes-conformance-pack` on this screen would display details related to that rule, as shown in <<conformance_pack1>>. 

[#conformance_pack1]
.Details related to the encrypted-volumes rule
[link=images/conformancepacks_1.png]
image::../images/conformancepacks_1.png[Conformance packs1]

You can update the AWS Config delivery channel to include an Amazon Simple Notification Service (Amazon SNS) topic to send email or text notifications when resources are flagged. More sophisticated approaches might include regularly reviewing AWS Config reports, using AWS Config's automatic remediation capabilities, or integrating AWS Config with security ticketing or security event and incident management (SEIM) practices. 

=== Operational Best Practices for PCI-DSS-3.2.1 conformance pack

While payment card industry (PCI) might not be a concern for every user of this Quick Start, many companies store, transmit, or process payment data. Whether or not you have PCI requirements, the PCI security conformance pack has over 140 rules that capture a number of best practices that any user should consider implementing.

If you do have PCI needs, read https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-pci-dss.html[Operational Best Practices for PCI DSS 3.2.1]. For every AWS Config rule included in a conformance pack, there's a corresponding PCI control ID along with AWS guidance for each check. This conformance pack was validated by https://aws.amazon.com/professional-services/security-assurance-services/[AWS Security Assurance Services LLC] (AWS SAS). AWS SAS is a team of PCI qualified security assessors (QSAs), HITRUST certified common security framework practitioners (CCSFPs), and compliance professionals certified to provide guidance and assessments for various industry frameworks.

WARNING: AWS Config conformance packs provide a general-purpose compliance framework designed to enable you to create security, operational or cost-optimization governance checks using managed or custom AWS Config rules and AWS Config remediation actions. Conformance packs, as sample templates, are not designed to fully ensure compliance with a specific governance or compliance standard. You are responsible for making your own assessment of whether your use of the services meets applicable legal and regulatory requirements.
       
== Other useful information
//Provide any other information of interest to users, especially focusing on areas where AWS or cloud usage differs from on-premises usage.

=== Where to go from here?
After you are connected to the VPN, you essentially have a private encrypted channel into your new VPCs. You can connect to any resources that you launch into your VPCs using private IP addresses without using insecure (public) bastion hosts. 

<<architecture2>> shows examples of the sorts of resources you might deploy into your VPCs and subnets. If you aren't sure which VPC or subnets you should deploy resources into, see the link:#_faq[FAQ] section for guidance and more examples. 

[#architecture2]
.{partner-product-short-name} architecture with example resources deployed
image::../images/AwsFintechBlueprint-architecture-diagram-filled-out.png[Architecture filled out]

//TODO Shivansh/Paul, FYI (no action needed), this figure is a nice addition. :)

=== (Optional) DNS setup
The Quick Start sets up a private DNS with `.corp` as the default apex domain using https://console.aws.amazon.com/route53/v2/home#Dashboard[Amazon Route 53 in your account]. Using the Amazon Route 53 console, you can create private `A` or `CNAME` records to any private resources you create. 

For example, you may decide to launch a development server that gets a private IP, such as `10.60.0.198`. Instead of having to remember that IP, you can create an `A` record in the `.corp` Route 53 hosted zone for `pauls-machine.corp` to the private IP `10.60.0.198`. Resources in all three VPCs and clients connected to the Client VPN endpoint then can all resolve `pauls-machine.corp` from a browser, terminal, API call, etc.

=== (Optional) Set up permissions for the AWS Service Catalog

You can deploy fintech tools into the {partner-product-name} environment from the AWS Service Catalog. The AWS Service Catalog requires that you give permissions to individual IAM users, groups, and roles to launch products from an AWS Service Catalog portfolio. To grant that permission, follow these steps:

. Navigate to the https://console.aws.amazon.com/servicecatalog/home?#portfolios?activeTab=localAdminPortfolios[AWS Service Catalog console]. 

. Choose *Fintech Blueprint Software Catalog* portfolio. 

. Choose the *Groups, roles, and users* tab, as shown in <<SCPermission>>. 
+
[#SCPermission]
.Granting permissions to groups, users, and roles
[link=images/service-catalog-permission.png]
image::../images/service-catalog-permission.png[scpermission]
+
. Choose the *Add groups, users, and roles* button.

. Select the IAM users, groups, or roles that you want grant permissions to. *Include yourself if you need permissions.*
+
Anyone you've added can visit the https://us-east-1.console.aws.amazon.com/servicecatalog/home?isSceuc=true&region=us-east-1#/products[products list section of the AWS Service Catalog console] and deploy any of the tools listed. For example, you or another user could go to the AWS Service Catalog console and deploy the SWIFT Client Connectivity Quick Start, as shown in <<SwiftQS>>.
+
[#SwiftQS]
.SWIFT Client Connectivity Quick Start in the AWS Service Catalog
[link=images/swiftservicecatalog.png]
image::../images/swiftservicecatalog.png[SwiftQS]

For tool-specific deployment and usage instructions, see the following documentation pages:

//TODO Shivansh/Paul, Please supply the documentation pages intended to follow this colon.

=== (Optional) Deploy the SWIFT Client Connectivity Quick Start

The SWIFT Client Connectivity Quick Start is a standardized environment for connecting to the SWIFT network. You can deploy the Quick Start into your AWS account from the AWS Service Catalog (as described in the previous section), from the links on the Quick Start's https://fwd.aws/4bpjr?[web page^], or from the links in its https://fwd.aws/agK6R?[deployment guide^]. 

When you deploy this Quick Start from the AWS Service Catalog, a continuous integration and continuous delivery (CI/CD) pipeline automatically deploys it in about 25 minutes. You can observe the progress in the AWS CodePipeline console, as shown in <<SwiftQSCodePipeline>>. 

[#SwiftQSCodePipeline]
.Deploying the SWIFT Client Connectivity Quick Start through AWS Service Catalog
[link=images/swift_codepipeline.png]
image::../images/swift_codepipeline.png[SwiftQSCodePipeline]

=== (Optional) Restrict IAM actions to specific AWS Regions 

//TODO Shivansh/Paul, Please revise this whole section—from here to the end of this .adoc file. (1) It's harder to read than the Biotech Blueprint section that describes the same things and is missing many of the edits that someone already made in Biotech. Maybe this Fintech guide based on an older version of the content? Everywhere possible, swap in the approved, edited paragraphs from the Biotech guide, and change only what's unique to Fintech. That will save me from re-creating a bunch of edits. (2) Pull the actions out into numbered steps. The steps get lost in all the description. (3) Do keep all your references you've added "as shown in Figure x"—those help.

A common request from startups using AWS is to restrict all IAM actions to specific Regions. For example, you may want users to create EC2 instances or S3 buckets in EU Regions only. This could be for compliance reasons or because it's a best practice to keep resources out of Regions you never intend to use. 

If you have a single AWS account, the best way to enforce Region restrictions is with an https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html[IAM permission boundary]. IAM permission boundaries are similar to, but distinct from, identity polices that you may be familiar with. An entity's permissions boundary allows it to perform only the actions that are allowed by both its identity-based policies *and* it's permissions boundaries. This means that even the broadest identity-based permission polices like 'arn:aws:iam::aws:policy/AdministratorAccess', which gives * access to *, will still be denied if the principal's permission boundary does not allow it.

The `RegionRestriction` class configured in 'lib/aws-startup-blueprint-stack.ts' creates just such an IAM permission boundary restriction actions to the regions you specify:

For example:

```typescript
      new RegionRestriction(this, 'RegionRestriction', {
        AllowedRegions: ["eu-central-1","eu-west-1","eu-west-3", "eu-south-1", "eu-north-1"]
      });  
```


We have added some helper context variables (`apply_EU_RegionRestriction` and `apply_US_RegionRestriction`) inside the the *cdk.json* file. Setting one of those to `true` and running `cdk deploy` again applies the Region restriction.

In order for the permission boundary to have any effect, it needs to be attached to all existing and future IAM users and roles. As a best practice, always attach this permission boundary when creating any IAM user or role. While a best practice, sometimes good intentions are forgotten. To enforce the permission boundary, the `RegionRestriction` class creates an AWS Config rule and remediation to detect and automatically fix a missing permission boundary to any existing, updated, or future IAM principals. 

If you visit the AWS Config Rules console, choose the rule titled `AwsFintechBlueprint-RegionRestriction...`, as shown in <<RegionRestriction>>.

[#RegionRestriction]
.Region restriction rule
[link=images/regionrestriction_config0.png]
image::../images/regionrestriction_config0.png[RegionRestriction]

The Config Rule will have evaluated all your IAM users and roles and listed their compliance status. You can quickly remediate a noncompliant resource by choosing the radio button next to it and choosing the *Remediate* button, shown in <<RegionRestrictionRemediation>>. That immediately applies the service control policy, and that user or role can no longer perform any action outside of the Region you specified. 

[#RegionRestrictionRemediation]
.Remediating the user's permissions to the desired Regions
[link=images/regionrestriction_config1.png]
image::../images/regionrestriction_config1.png[RegionRestrictionRemediation]

After the remediation is complete, AWS CloudTrail eventually triggers the AWS Config rule. CloudTrail tells AWS Config that the IAM principal has been updated and that it's time to reevaluate the offending resource. (This takes about 15 minutes.) Because the boundary has been applied, the reevaluation reports the role or user as compliant.

==== Enable automatic remediation

The Quick Start leaves the remediation configuration set to manual instead of automatic in case you have existing IAM users or roles. Automatically applying the remediation and attaching the permission boundary impacts those existing IAM principals' permissions. Verify if any of the flagged IAM principals depend on any nonapproved Regions before applying the boundary. If you are working in a new account or are unconcerned about the impact on existing IAM principals, turn on automatic remediation, as follows: 

Choose the *Edit* button in the *Remediation action* section of the `AwsFintechBlueprint-RegionRestriction` Config rule, as shown in <<RegionRestrictionRemediationEditAuto>>:

[#RegionRestrictionRemediationEditAuto]
.Editing the remediation action
[link=images/regionrestriction_config2.png]
image::../images/regionrestriction_config2.png[RegionRestrictionRemediationEditAuto]

WARNING: Turning on automatic remediation will impact existing IAM users and roles not created by the Blueprint itself. Any existing users/roles that are automatically remediated will have their effective permissions limited to the Regions you specify. This could potentially break existing processes that rely on resources outside of the allowed Regions.

Choose the *Automatic Remediation* radio button, and then choose *Save changes*, as shown in <<RegionRestrictionRemediationAuto>>.

[#RegionRestrictionRemediationAuto]
.Setting up automatic remediation to lock users down to specific Regions
[link=images/regionrestriction_config3.png]
image::../images/regionrestriction_config3.png[RegionRestrictionRemediationAuto] 

==== Restrict AWS Regions in multi-account configurations

In a multi-account setup, service control polices (SCPs) are superior to permission boundaries. SCPs are applied across an entire account and don't need to be individually attached to IAM principals. Note that SCPs can only take effect on your subaccounts. So if you have only one account, SCPs can't help. Thats no problem. The permission boundary and AWS Config approach are enough restrict Regions in a single account setup. But when you create a new account, the Quick Start has already created a Region restricting SCP that is automatically applied to any new account you create.

<<SCP>> shows what the service control policy looks like in the https://console.aws.amazon.com/iam/home?organizations/ServiceControlPolicies/#/organizations/ServiceControlPolicies[IAM console].

TIP: The SCP created by the {partner-product-name} applies only to your subaccounts if and when you create them. The permission boundary restricts permissions in your root account.

[#SCP]
.The service control policy that restricts actions in subaccounts when the time comes to create them
[link=images/regionrestriction_config4.png]
image::../images/regionrestriction_config4.png[SCP] 